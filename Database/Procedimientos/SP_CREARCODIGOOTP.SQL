CREATE OR REPLACE PROCEDURE SP_CREARCODIGOOTP (MAIL_IN IN VARCHAR2, RUN_IN IN NUMBER, SALIDA_OUT OUT VARCHAR)
IS
    CODIGO_ALEATORIO VARCHAR(150);
    VALIDADOR_EXISTENCIA NUMBER;
    VALIDADOR_USUARIO_EXISTE NUMBER;
BEGIN
    VALIDADOR_USUARIO_EXISTE:=F_VALIDAREXISTENCIAUSUARIO(MAIL_IN, RUN_IN);
    VALIDADOR_EXISTENCIA:=F_VALIDAREXISTENCIACODIGO(MAIL_IN, RUN_IN);
    CODIGO_ALEATORIO:=F_CODIGOALEATORIO();
    IF VALIDADOR_EXISTENCIA >0 THEN
        UPDATE GESTION_OTP SET ESTADO='X' WHERE ID_GESTION = VALIDADOR_EXISTENCIA;
        COMMIT;
    END IF;
    IF VALIDADOR_USUARIO_EXISTE > 0 THEN
        INSERT INTO GESTION_OTP (ID_GESTION, MAIL, RUN, HORA_ENVIO, CODIGO_OTP, USADO, ESTADO)
            VALUES((SELECT NVL(MAX(ID_GESTION), 0)+1 FROM GESTION_OTP), MAIL_IN, RUN_IN, CURRENT_TIMESTAMP, CODIGO_ALEATORIO,0, 'A' );
        COMMIT;
        SALIDA_OUT:=CODIGO_ALEATORIO; --CREO CODIGO OTP
    ELSE
        SALIDA_OUT:='-1';
    END IF;
    
END;