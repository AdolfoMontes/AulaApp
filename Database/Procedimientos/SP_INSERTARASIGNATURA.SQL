CREATE OR REPLACE PROCEDURE SP_INSERTARASIGNATURA(NOM_IN IN VARCHAR2, COD_IN IN VARCHAR2, ANIO_IN IN NUMBER,
                        DOC_IN IN NUMBER, SALA_IN IN NUMBER, CURSO_IN IN NUMBER, CALCULO_IN NUMBER, USR_CREACION_IN VARCHAR2, RESULTADO_OUT OUT NUMBER)
IS 
    VALIDADOR_ASIGNATURA NUMBER;
    ERROR VARCHAR(1000);
    MAX_ID NUMBER;
    CURSOR ALUMNOS_CURSO IS
        SELECT RUN, DV, PRI_NOM, SEG_NOM, PRI_AP, SEG_AP, ID_CURSO

        FROM PERSONA WHERE ID_ROL =5 AND ID_CURSO = CURSO_IN; 
        FILA_VAR ALUMNOS_CURSO%ROWTYPE;
BEGIN
    VALIDADOR_ASIGNATURA := F_VALIDAREXISTENCIAASIGNATURA(COD_IN); -- SI EL CODIGO DE ASIGNATURA NO EXISTE, ENTONCES REGISTRO
    SELECT NVL(MAX(ID_ASIGNATURA),0 )+1 INTO MAX_ID FROM ASIGNATURA;
    IF VALIDADOR_ASIGNATURA = 0 THEN
        INSERT INTO ASIGNATURA(ID_ASIGNATURA, NOM_ASIGNATURA, COD_ASIGNATURA, ANIO, ESTADO, USR_CREACION, FECHA_CREACION, CALCULO, ID_CURSO, ID_SALA,
                            DOC_ASIGNADO) VALUES 
                            (MAX_ID, NOM_IN, COD_IN, ANIO_IN, 'A', USR_CREACION_IN,
                            CURRENT_TIMESTAMP, CALCULO_IN, CURSO_IN, SALA_IN, DOC_IN );
    FOR FILA_VAR IN ALUMNOS_CURSO
    LOOP
        INSERT INTO PERSONA_ASIGNATURA (RUN, ID_ASIGNATURA) VALUES (FILA_VAR.RUN, MAX_ID);
    END LOOP;
    RESULTADO_OUT := 0;
    ELSIF VALIDADOR_ASIGNATURA = -2 THEN
        UPDATE ASIGNATURA SET DOC_ASIGNADO = DOC_IN, CALCULO = CALCULO_IN WHERE COD_ASIGNATURA=COD_IN;
        RESULTADO_OUT:= -2;

    END IF;
    COMMIT;
    
EXCEPTION WHEN OTHERS THEN
    ERROR:=SQLERRM;
    RESULTADO_OUT :=-1;
    DBMS_OUTPUT.PUT_LINE(ERROR);
    ROLLBACK;
END;